{% extends 'base.html' %}

{% block title %}Auto Execution - Portfolio Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="bi bi-lightning-charge"></i> Auto Execution Portfolio</h2>
            <p class="text-muted mb-0">Automatic trade execution with TP/SL monitoring and accuracy tracking</p>
        </div>
        <div>
            <span class="badge bg-{{ 'success' if settings.enabled else 'secondary' }} fs-6" id="statusBadge">
                {{ 'AUTO ON' if settings.enabled else 'AUTO OFF' }}
            </span>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-3">
    <div class="col-md-2">
        <div class="card card-primary">
            <div class="card-body text-center py-2">
                <small class="text-muted">Accuracy</small>
                <h4 class="mb-0 {{ 'text-success' if stats.accuracy_rate >= 50 else 'text-danger' }}">{{ stats.accuracy_rate }}%</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-success">
            <div class="card-body text-center py-2">
                <small class="text-muted">Win Rate</small>
                <h4 class="mb-0 text-success">{{ stats.win_rate }}%</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-{{ 'success' if stats.total_pnl >= 0 else 'danger' }}">
            <div class="card-body text-center py-2">
                <small class="text-muted">Total P&L</small>
                <h4 class="mb-0 {{ 'text-success' if stats.total_pnl >= 0 else 'text-danger' }}">${{ stats.total_pnl }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <small class="text-muted">TP Hits</small>
                <h4 class="mb-0 text-success">{{ stats.tp_hits }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <small class="text-muted">SL Hits</small>
                <h4 class="mb-0 text-danger">{{ stats.sl_hits }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center py-2">
                <small class="text-muted">Today</small>
                <h4 class="mb-0 text-primary">{{ stats.today_trades }}</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Settings Sidebar -->
    <div class="col-md-3">
        <!-- Auto Settings -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-robot"></i> Auto Settings
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="autoEnabled" {{ 'checked' if settings.enabled else '' }}>
                    <label class="form-check-label" for="autoEnabled">Enable Auto Scanning</label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="autoExecute" {{ 'checked' if settings.auto_execute else '' }}>
                    <label class="form-check-label" for="autoExecute">Auto Execute Trades</label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="telegramAlerts" {{ 'checked' if settings.telegram_alerts else '' }}>
                    <label class="form-check-label" for="telegramAlerts">Telegram Alerts</label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Scan Interval (min)</label>
                    <select id="scanInterval" class="form-select">
                        <option value="15" {{ 'selected' if settings.scan_interval == 15 else '' }}>15 Minutes</option>
                        <option value="30" {{ 'selected' if settings.scan_interval == 30 else '' }}>30 Minutes</option>
                        <option value="60" {{ 'selected' if settings.scan_interval == 60 else '' }}>1 Hour</option>
                        <option value="240" {{ 'selected' if settings.scan_interval == 240 else '' }}>4 Hours</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Trading Method</label>
                    <select id="tradingMethod" class="form-select">
                        <option value="ML" {{ 'selected' if settings.trading_method == 'ML' else '' }}>
                            <i class="bi bi-cpu"></i> ML (Machine Learning)
                        </option>
                        <option value="ICT" {{ 'selected' if settings.trading_method == 'ICT' else '' }}>
                            <i class="bi bi-bank"></i> ICT (Smart Money)
                        </option>
                        <option value="HYBRID" {{ 'selected' if settings.trading_method == 'HYBRID' else '' }}>
                            <i class="bi bi-intersect"></i> Hybrid (ML + ICT)
                        </option>
                    </select>
                    <small class="text-muted">
                        <span id="methodDescription">
                            {% if settings.trading_method == 'ICT' %}
                                Uses Kill Zones, Order Blocks, FVG, BOS/ChoCH
                            {% elif settings.trading_method == 'HYBRID' %}
                                Combines ML signals with ICT confirmation
                            {% else %}
                                Uses Ensemble strategies (Momentum, Mean Reversion, Breakout)
                            {% endif %}
                        </span>
                    </small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Probability Threshold (%)</label>
                    <input type="number" id="probThreshold" class="form-control" value="{{ settings.probability_threshold }}" min="50" max="95" step="5">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Max Trades / Day</label>
                    <input type="number" id="maxPositions" class="form-control" value="{{ settings.max_open_positions }}" min="1" max="20">
                    <small class="text-muted">Today: {{ stats.today_trades }}/{{ settings.max_open_positions }}</small>
                </div>
                
                <button id="saveSettingsBtn" class="btn btn-primary w-100 mb-2">
                    <i class="bi bi-save"></i> Save Settings
                </button>
                
                <button id="manualScanBtn" class="btn btn-success w-100">
                    <i class="bi bi-search"></i> Manual Scan Now
                </button>
            </div>
        </div>

        <!-- Manual Scan Settings -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-gear"></i> Manual Scan
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Balance ($)</label>
                    <input type="number" id="balance" class="form-control" value="{{ balance }}" min="100">
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Period</label>
                        <select id="period" class="form-select">
                            <option value="1mo">1 Month</option>
                            <option value="3mo" selected>3 Months</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Timeframe</label>
                        <select id="interval" class="form-select">
                            <option value="1h" selected>1 Hour</option>
                            <option value="4h">4 Hours</option>
                        </select>
                    </div>
                </div>
                
                <button id="scanBtn" class="btn btn-outline-primary w-100 mb-2">
                    <i class="bi bi-search"></i> Scan Selected Pairs
                </button>
                
                <button id="simulateBtn" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-play-circle"></i> Simulate Portfolio
                </button>
                
                <div id="loading" class="text-center mt-2 d-none">
                    <div class="spinner-border spinner-border-sm"></div> Processing...
                </div>
            </div>
        </div>

        <!-- Portfolio Stats -->
        <div class="card mb-3" id="statsCard" style="display:none;">
            <div class="card-header">
                <i class="bi bi-bar-chart-line"></i> Portfolio Stats
            </div>
            <div class="card-body" id="statsContent">
            </div>
        </div>

        <!-- Pairs Selection -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-star"></i> Trading Pairs</span>
                <small class="text-muted" id="pairCount">0 selected</small>
            </div>
            <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="selectAllPairs()">All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="selectNonePairs()">None</button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="selectMajors()">Majors</button>
                </div>
                
                <!-- Major Pairs -->
                <div class="mb-2">
                    <small class="text-primary fw-bold"><i class="bi bi-currency-exchange"></i> MAJORS</small>
                    <div class="row g-0">
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="EUR/USD" id="eurusd" {{ 'checked' if 'EUR/USD' in settings.pairs else '' }}><label class="form-check-label small" for="eurusd">EUR/USD</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="GBP/USD" id="gbpusd" {{ 'checked' if 'GBP/USD' in settings.pairs else '' }}><label class="form-check-label small" for="gbpusd">GBP/USD</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="USD/JPY" id="usdjpy" {{ 'checked' if 'USD/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="usdjpy">USD/JPY</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="USD/CHF" id="usdchf" {{ 'checked' if 'USD/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="usdchf">USD/CHF</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="AUD/USD" id="audusd" {{ 'checked' if 'AUD/USD' in settings.pairs else '' }}><label class="form-check-label small" for="audusd">AUD/USD</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="USD/CAD" id="usdcad" {{ 'checked' if 'USD/CAD' in settings.pairs else '' }}><label class="form-check-label small" for="usdcad">USD/CAD</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check major" type="checkbox" value="NZD/USD" id="nzdusd" {{ 'checked' if 'NZD/USD' in settings.pairs else '' }}><label class="form-check-label small" for="nzdusd">NZD/USD</label></div></div>
                    </div>
                </div>

                <!-- Cross Pairs -->
                <div class="mb-2">
                    <small class="text-secondary fw-bold cursor-pointer" data-bs-toggle="collapse" data-bs-target="#crossPairs"><i class="bi bi-chevron-down"></i> CROSSES</small>
                    <div class="collapse" id="crossPairs">
                        <div class="row g-0">
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/GBP" id="eurgbp" {{ 'checked' if 'EUR/GBP' in settings.pairs else '' }}><label class="form-check-label small" for="eurgbp">EUR/GBP</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/JPY" id="eurjpy" {{ 'checked' if 'EUR/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="eurjpy">EUR/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/AUD" id="euraud" {{ 'checked' if 'EUR/AUD' in settings.pairs else '' }}><label class="form-check-label small" for="euraud">EUR/AUD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/CAD" id="eurcad" {{ 'checked' if 'EUR/CAD' in settings.pairs else '' }}><label class="form-check-label small" for="eurcad">EUR/CAD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/CHF" id="eurchf" {{ 'checked' if 'EUR/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="eurchf">EUR/CHF</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/NZD" id="eurnzd" {{ 'checked' if 'EUR/NZD' in settings.pairs else '' }}><label class="form-check-label small" for="eurnzd">EUR/NZD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="GBP/JPY" id="gbpjpy" {{ 'checked' if 'GBP/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="gbpjpy">GBP/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="GBP/AUD" id="gbpaud" {{ 'checked' if 'GBP/AUD' in settings.pairs else '' }}><label class="form-check-label small" for="gbpaud">GBP/AUD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="GBP/CAD" id="gbpcad" {{ 'checked' if 'GBP/CAD' in settings.pairs else '' }}><label class="form-check-label small" for="gbpcad">GBP/CAD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="GBP/CHF" id="gbpchf" {{ 'checked' if 'GBP/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="gbpchf">GBP/CHF</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="GBP/NZD" id="gbpnzd" {{ 'checked' if 'GBP/NZD' in settings.pairs else '' }}><label class="form-check-label small" for="gbpnzd">GBP/NZD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AUD/JPY" id="audjpy" {{ 'checked' if 'AUD/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="audjpy">AUD/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AUD/CAD" id="audcad" {{ 'checked' if 'AUD/CAD' in settings.pairs else '' }}><label class="form-check-label small" for="audcad">AUD/CAD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AUD/CHF" id="audchf" {{ 'checked' if 'AUD/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="audchf">AUD/CHF</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AUD/NZD" id="audnzd" {{ 'checked' if 'AUD/NZD' in settings.pairs else '' }}><label class="form-check-label small" for="audnzd">AUD/NZD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="CAD/JPY" id="cadjpy" {{ 'checked' if 'CAD/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="cadjpy">CAD/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="CAD/CHF" id="cadchf" {{ 'checked' if 'CAD/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="cadchf">CAD/CHF</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="CHF/JPY" id="chfjpy" {{ 'checked' if 'CHF/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="chfjpy">CHF/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="NZD/JPY" id="nzdjpy" {{ 'checked' if 'NZD/JPY' in settings.pairs else '' }}><label class="form-check-label small" for="nzdjpy">NZD/JPY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="NZD/CAD" id="nzdcad" {{ 'checked' if 'NZD/CAD' in settings.pairs else '' }}><label class="form-check-label small" for="nzdcad">NZD/CAD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="NZD/CHF" id="nzdchf" {{ 'checked' if 'NZD/CHF' in settings.pairs else '' }}><label class="form-check-label small" for="nzdchf">NZD/CHF</label></div></div>
                        </div>
                    </div>
                </div>

                <!-- Exotic Pairs -->
                <div class="mb-2">
                    <small class="text-warning fw-bold cursor-pointer" data-bs-toggle="collapse" data-bs-target="#exoticPairs"><i class="bi bi-chevron-down"></i> EXOTICS</small>
                    <div class="collapse" id="exoticPairs">
                        <div class="row g-0">
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/SGD" id="usdsgd" {{ 'checked' if 'USD/SGD' in settings.pairs else '' }}><label class="form-check-label small" for="usdsgd">USD/SGD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/HKD" id="usdhkd" {{ 'checked' if 'USD/HKD' in settings.pairs else '' }}><label class="form-check-label small" for="usdhkd">USD/HKD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/MXN" id="usdmxn" {{ 'checked' if 'USD/MXN' in settings.pairs else '' }}><label class="form-check-label small" for="usdmxn">USD/MXN</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/ZAR" id="usdzar" {{ 'checked' if 'USD/ZAR' in settings.pairs else '' }}><label class="form-check-label small" for="usdzar">USD/ZAR</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/TRY" id="usdtry" {{ 'checked' if 'USD/TRY' in settings.pairs else '' }}><label class="form-check-label small" for="usdtry">USD/TRY</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/SEK" id="usdsek" {{ 'checked' if 'USD/SEK' in settings.pairs else '' }}><label class="form-check-label small" for="usdsek">USD/SEK</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/NOK" id="usdnok" {{ 'checked' if 'USD/NOK' in settings.pairs else '' }}><label class="form-check-label small" for="usdnok">USD/NOK</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="USD/DKK" id="usddkk" {{ 'checked' if 'USD/DKK' in settings.pairs else '' }}><label class="form-check-label small" for="usddkk">USD/DKK</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/SEK" id="eursek" {{ 'checked' if 'EUR/SEK' in settings.pairs else '' }}><label class="form-check-label small" for="eursek">EUR/SEK</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/NOK" id="eurnok" {{ 'checked' if 'EUR/NOK' in settings.pairs else '' }}><label class="form-check-label small" for="eurnok">EUR/NOK</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EUR/TRY" id="eurtry" {{ 'checked' if 'EUR/TRY' in settings.pairs else '' }}><label class="form-check-label small" for="eurtry">EUR/TRY</label></div></div>
                        </div>
                    </div>
                </div>

                <!-- Commodities -->
                <div class="mb-2">
                    <small class="text-success fw-bold"><i class="bi bi-gem"></i> COMMODITIES</small>
                    <div class="row g-0">
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="XAU/USD" id="xauusd" {{ 'checked' if 'XAU/USD' in settings.pairs else '' }}><label class="form-check-label small" for="xauusd">XAU/USD <small class="text-muted">Gold</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="XAG/USD" id="xagusd" {{ 'checked' if 'XAG/USD' in settings.pairs else '' }}><label class="form-check-label small" for="xagusd">XAG/USD <small class="text-muted">Silver</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="WTI/USD" id="wtiusd" {{ 'checked' if 'WTI/USD' in settings.pairs else '' }}><label class="form-check-label small" for="wtiusd">WTI/USD <small class="text-muted">Oil</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="BRENT" id="brent" {{ 'checked' if 'BRENT' in settings.pairs else '' }}><label class="form-check-label small" for="brent">BRENT <small class="text-muted">Oil</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="NGAS" id="ngas" {{ 'checked' if 'NGAS' in settings.pairs else '' }}><label class="form-check-label small" for="ngas">NGAS <small class="text-muted">NatGas</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="COPPER" id="copper" {{ 'checked' if 'COPPER' in settings.pairs else '' }}><label class="form-check-label small" for="copper">COPPER</label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="PLAT" id="plat" {{ 'checked' if 'PLAT' in settings.pairs else '' }}><label class="form-check-label small" for="plat">PLAT <small class="text-muted">Platinum</small></label></div></div>
                    </div>
                </div>

                <!-- Crypto -->
                <div class="mb-2">
                    <small class="text-info fw-bold cursor-pointer" data-bs-toggle="collapse" data-bs-target="#cryptoPairs"><i class="bi bi-currency-bitcoin"></i> CRYPTO</small>
                    <div class="collapse show" id="cryptoPairs">
                        <div class="row g-0">
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="BTC/USD" id="btcusd" {{ 'checked' if 'BTC/USD' in settings.pairs else '' }}><label class="form-check-label small" for="btcusd">BTC/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="ETH/USD" id="ethusd" {{ 'checked' if 'ETH/USD' in settings.pairs else '' }}><label class="form-check-label small" for="ethusd">ETH/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="XRP/USD" id="xrpusd" {{ 'checked' if 'XRP/USD' in settings.pairs else '' }}><label class="form-check-label small" for="xrpusd">XRP/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="SOL/USD" id="solusd" {{ 'checked' if 'SOL/USD' in settings.pairs else '' }}><label class="form-check-label small" for="solusd">SOL/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="BNB/USD" id="bnbusd" {{ 'checked' if 'BNB/USD' in settings.pairs else '' }}><label class="form-check-label small" for="bnbusd">BNB/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="ADA/USD" id="adausd" {{ 'checked' if 'ADA/USD' in settings.pairs else '' }}><label class="form-check-label small" for="adausd">ADA/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="DOGE/USD" id="dogeusd" {{ 'checked' if 'DOGE/USD' in settings.pairs else '' }}><label class="form-check-label small" for="dogeusd">DOGE/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="DOT/USD" id="dotusd" {{ 'checked' if 'DOT/USD' in settings.pairs else '' }}><label class="form-check-label small" for="dotusd">DOT/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="MATIC/USD" id="maticusd" {{ 'checked' if 'MATIC/USD' in settings.pairs else '' }}><label class="form-check-label small" for="maticusd">MATIC/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="LTC/USD" id="ltcusd" {{ 'checked' if 'LTC/USD' in settings.pairs else '' }}><label class="form-check-label small" for="ltcusd">LTC/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AVAX/USD" id="avaxusd" {{ 'checked' if 'AVAX/USD' in settings.pairs else '' }}><label class="form-check-label small" for="avaxusd">AVAX/USD</label></div></div>
                            <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="LINK/USD" id="linkusd" {{ 'checked' if 'LINK/USD' in settings.pairs else '' }}><label class="form-check-label small" for="linkusd">LINK/USD</label></div></div>
                        </div>
                    </div>
                </div>

                <!-- Indices -->
                <div class="mb-2">
                    <small class="text-danger fw-bold"><i class="bi bi-graph-up"></i> INDICES</small>
                    <div class="row g-0">
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="US500" id="us500" {{ 'checked' if 'US500' in settings.pairs else '' }}><label class="form-check-label small" for="us500">US500 <small class="text-muted">S&P</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="US100" id="us100" {{ 'checked' if 'US100' in settings.pairs else '' }}><label class="form-check-label small" for="us100">US100 <small class="text-muted">NAS</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="US30" id="us30" {{ 'checked' if 'US30' in settings.pairs else '' }}><label class="form-check-label small" for="us30">US30 <small class="text-muted">DOW</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="DE40" id="de40" {{ 'checked' if 'DE40' in settings.pairs else '' }}><label class="form-check-label small" for="de40">DE40 <small class="text-muted">DAX</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="UK100" id="uk100" {{ 'checked' if 'UK100' in settings.pairs else '' }}><label class="form-check-label small" for="uk100">UK100 <small class="text-muted">FTSE</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="JP225" id="jp225" {{ 'checked' if 'JP225' in settings.pairs else '' }}><label class="form-check-label small" for="jp225">JP225 <small class="text-muted">Nikkei</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="AU200" id="au200" {{ 'checked' if 'AU200' in settings.pairs else '' }}><label class="form-check-label small" for="au200">AU200 <small class="text-muted">ASX</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="EU50" id="eu50" {{ 'checked' if 'EU50' in settings.pairs else '' }}><label class="form-check-label small" for="eu50">EU50 <small class="text-muted">STOXX</small></label></div></div>
                        <div class="col-6"><div class="form-check form-check-inline"><input class="form-check-input pair-check" type="checkbox" value="VIX" id="vix" {{ 'checked' if 'VIX' in settings.pairs else '' }}><label class="form-check-label small" for="vix">VIX <small class="text-muted">Fear</small></label></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Open Positions -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-briefcase"></i> Open Positions</span>
                <span class="badge bg-light text-dark">{{ open_positions|length }} active</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Pair</th>
                                <th>Direction</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>SL</th>
                                <th>TP</th>
                                <th>P&L</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if open_positions %}
                                {% for pos in open_positions %}
                                <tr>
                                    <td><strong>{{ pos.pair }}</strong></td>
                                    <td><span class="badge {{ 'badge-soft-success' if pos.direction == 'BUY' else 'badge-soft-danger' }}">{{ pos.direction }}</span></td>
                                    <td>{{ pos.entry_price }}</td>
                                    <td>{{ pos.current_price or '-' }}</td>
                                    <td class="text-danger">{{ pos.stop_loss }}</td>
                                    <td class="text-success">{{ pos.take_profit }}</td>
                                    <td>
                                        {% if pos.current_price %}
                                            {% set pnl = (pos.current_price - pos.entry_price) * 10000 if pos.direction == 'BUY' else (pos.entry_price - pos.current_price) * 10000 %}
                                            <span class="{{ 'text-success' if pnl >= 0 else 'text-danger' }}">{{ '%.1f'|format(pnl) }} pips</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="closePosition({{ pos.id }})">Close</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="8" class="text-center text-muted py-3">No open positions</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Execution History -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history"></i> Execution History</span>
                <span class="badge bg-secondary">{{ executions|length }} trades</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Date</th>
                                <th>Pair</th>
                                <th>Direction</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Result</th>
                                <th>P&L</th>
                                <th>Accuracy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if executions %}
                                {% for exec in executions %}
                                <tr>
                                    <td class="small">{{ exec.created_at[:16] if exec.created_at else '-' }}</td>
                                    <td><strong>{{ exec.pair }}</strong></td>
                                    <td><span class="badge {{ 'badge-soft-success' if exec.direction == 'BUY' else 'badge-soft-danger' }}">{{ exec.direction }}</span></td>
                                    <td>{{ exec.entry_price }}</td>
                                    <td>{{ exec.exit_price or '-' }}</td>
                                    <td>
                                        {% if exec.status == 'closed' %}
                                            <span class="badge {{ 'bg-success' if exec.exit_reason == 'TP_HIT' else 'bg-danger' }}">
                                                {{ exec.exit_reason|replace('_', ' ') if exec.exit_reason else '-' }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-primary">OPEN</span>
                                        {% endif %}
                                    </td>
                                    <td class="{{ 'text-success' if exec.pnl and exec.pnl > 0 else 'text-danger' if exec.pnl and exec.pnl < 0 else '' }}">
                                        {{ '$%.2f'|format(exec.pnl) if exec.pnl else '-' }}
                                    </td>
                                    <td>
                                        {% if exec.is_correct is not none %}
                                            {% if exec.is_correct %}
                                                <i class="bi bi-check-circle-fill text-success"></i> Correct
                                            {% else %}
                                                <i class="bi bi-x-circle-fill text-danger"></i> Wrong
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="8" class="text-center text-muted py-3">No execution history</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Manual Scan Results -->
        <div class="card mb-3" id="signalsCard" style="display:none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-lightning-charge"></i> Scan Results</span>
                <span class="badge bg-secondary" id="signalCount">0 signals</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="signalsTable">
                        <thead>
                            <tr>
                                <th>Pair</th>
                                <th>Signal</th>
                                <th>Probability</th>
                                <th>Entry</th>
                                <th>SL</th>
                                <th>TP</th>
                                <th>Lots</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="signalsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Activity Logs -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-text"></i> Activity Logs</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm mb-0">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Pair</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody">
                            {% if logs %}
                                {% for log in logs %}
                                <tr>
                                    <td class="small text-muted">{{ log.created_at[11:19] if log.created_at else '-' }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if 'EXECUTED' in log.action %}bg-success
                                            {% elif 'CLOSED' in log.action %}bg-info
                                            {% elif 'SCAN' in log.action %}bg-secondary
                                            {% elif 'SIGNAL' in log.action %}bg-warning
                                            {% else %}bg-light text-dark{% endif %}">
                                            {{ log.action }}
                                        </span>
                                    </td>
                                    <td>{{ log.pair or '-' }}</td>
                                    <td class="small">{{ log.details or '-' }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="4" class="text-center text-muted py-2">No activity logs</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
// Pair selection helpers
function updatePairCount() {
    const count = document.querySelectorAll('.pair-check:checked').length;
    document.getElementById('pairCount').textContent = count + ' selected';
}

function selectAllPairs() {
    document.querySelectorAll('.pair-check').forEach(cb => cb.checked = true);
    updatePairCount();
}

function selectNonePairs() {
    document.querySelectorAll('.pair-check').forEach(cb => cb.checked = false);
    updatePairCount();
}

function selectMajors() {
    document.querySelectorAll('.pair-check').forEach(cb => cb.checked = false);
    document.querySelectorAll('.pair-check.major').forEach(cb => cb.checked = true);
    updatePairCount();
}

// Update count on page load and checkbox change
document.addEventListener('DOMContentLoaded', () => {
    updatePairCount();
    document.querySelectorAll('.pair-check').forEach(cb => {
        cb.addEventListener('change', updatePairCount);
    });
});

// Save Settings
document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
    const selectedPairs = [];
    document.querySelectorAll('.pair-check:checked').forEach(cb => {
        selectedPairs.push(cb.value);
    });
    
    const data = {
        enabled: document.getElementById('autoEnabled').checked ? 1 : 0,
        auto_execute: document.getElementById('autoExecute').checked ? 1 : 0,
        telegram_alerts: document.getElementById('telegramAlerts').checked ? 1 : 0,
        scan_interval: parseInt(document.getElementById('scanInterval').value),
        probability_threshold: parseFloat(document.getElementById('probThreshold').value),
        max_open_positions: parseInt(document.getElementById('maxPositions').value),
        trading_method: document.getElementById('tradingMethod').value,
        pairs: selectedPairs.join(',')
    };
    
    try {
        const response = await fetch('/save_auto_settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            // Update status badge
            const badge = document.getElementById('statusBadge');
            if (data.enabled) {
                badge.textContent = 'AUTO ON';
                badge.classList.remove('bg-secondary');
                badge.classList.add('bg-success');
            } else {
                badge.textContent = 'AUTO OFF';
                badge.classList.remove('bg-success');
                badge.classList.add('bg-secondary');
            }
            alert('Settings saved successfully!');
        }
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
});

// Manual Scan
document.getElementById('manualScanBtn').addEventListener('click', async () => {
    const btn = document.getElementById('manualScanBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';
    
    try {
        const response = await fetch('/trigger_manual_scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Scan completed! Check logs for results.');
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search"></i> Manual Scan Now';
    }
});

// Scan Selected Pairs
document.getElementById('scanBtn').addEventListener('click', async () => {
    const selectedPairs = [];
    document.querySelectorAll('.pair-check:checked').forEach(cb => {
        selectedPairs.push(cb.value);
    });
    
    if (selectedPairs.length === 0) {
        alert('Please select at least one pair');
        return;
    }
    
    const data = {
        pairs: selectedPairs,
        period: document.getElementById('period').value,
        interval: document.getElementById('interval').value,
        balance: parseFloat(document.getElementById('balance').value),
        risk_percent: 1.0
    };
    
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('scanBtn').disabled = true;
    document.getElementById('error').style.display = 'none';
    
    try {
        const response = await fetch('/scan_execution', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        displaySignals(result.signals);
        
    } catch (error) {
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
    } finally {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('scanBtn').disabled = false;
    }
});

// Simulate Portfolio
document.getElementById('simulateBtn').addEventListener('click', async () => {
    const data = {
        initial_balance: parseFloat(document.getElementById('balance').value),
        risk_percent: 1.0,
        period: document.getElementById('period').value
    };
    
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('simulateBtn').disabled = true;
    
    try {
        const response = await fetch('/simulate_portfolio', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        alert(`Simulation Complete!\n\nTotal Trades: ${result.stats.total_trades}\nWin Rate: ${result.stats.win_rate}%\nTotal P&L: $${result.stats.total_pnl}`);
        
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('simulateBtn').disabled = false;
    }
});

function displaySignals(signals) {
    document.getElementById('signalsCard').style.display = 'block';
    const tbody = document.getElementById('signalsBody');
    tbody.innerHTML = '';
    
    document.getElementById('signalCount').textContent = signals.length + ' signals';
    
    if (signals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No signals found</td></tr>';
        return;
    }
    
    signals.forEach(sig => {
        const signalClass = sig.signal === 'BUY' ? 'badge-soft-success' : sig.signal === 'SELL' ? 'badge-soft-danger' : 'bg-secondary';
        const probClass = sig.execution_probability >= 70 ? 'text-success' : sig.execution_probability >= 50 ? 'text-warning' : 'text-danger';
        
        tbody.innerHTML += `
            <tr>
                <td><strong>${sig.pair}</strong></td>
                <td><span class="badge ${signalClass}">${sig.signal}</span></td>
                <td>
                    <strong class="${probClass}">${sig.execution_probability}%</strong>
                </td>
                <td>${sig.entry || '-'}</td>
                <td class="text-danger">${sig.stop_loss || '-'}</td>
                <td class="text-success">${sig.take_profit || '-'}</td>
                <td>${sig.lots}</td>
                <td>
                    ${sig.should_execute 
                        ? `<button class="btn btn-sm btn-success" onclick="executeTrade('${sig.pair}', '${sig.signal}', ${sig.entry}, ${sig.stop_loss}, ${sig.take_profit}, ${sig.lots}, ${sig.execution_probability})"><i class="bi bi-check"></i> Execute</button>`
                        : '<span class="text-muted small">Low prob</span>'
                    }
                </td>
            </tr>
        `;
    });
}

async function executeTrade(pair, direction, entry, sl, tp, lots, probability) {
    if (!confirm(`Execute ${direction} on ${pair}?`)) return;
    
    try {
        const response = await fetch('/execute_auto_trade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pair: pair,
                direction: direction,
                entry: entry,
                stop_loss: sl,
                take_profit: tp,
                lots: lots,
                probability: probability
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Trade executed successfully!');
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function closePosition(positionId) {
    if (!confirm('Close this position at current price?')) return;
    
    try {
        const response = await fetch('/close_auto_position/' + positionId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert(`Position closed! P&L: $${result.pnl}`);
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function refreshLogs() {
    location.reload();
}

// Update method description on change
document.getElementById('tradingMethod').addEventListener('change', function() {
    const desc = document.getElementById('methodDescription');
    const method = this.value;
    
    if (method === 'ICT') {
        desc.innerHTML = 'Uses Kill Zones, Order Blocks, FVG, BOS/ChoCH';
    } else if (method === 'HYBRID') {
        desc.innerHTML = 'Combines ML signals with ICT confirmation';
    } else {
        desc.innerHTML = 'Uses Ensemble strategies (Momentum, Mean Reversion, Breakout)';
    }
});

// Auto-refresh every 60 seconds if auto is enabled
{% if settings.enabled %}
setInterval(() => {
    location.reload();
}, 60000);
{% endif %}
</script>
{% endblock %}
