{% extends 'base.html' %}

{% block title %}Position Calculator - Forex Risk Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-calculator"></i> Position Size Calculator</h2>
        <p class="text-muted">Calculate your optimal lot size based on risk management principles</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-sliders"></i> Calculator Input
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Account Balance ($)</label>
                    <input type="number" id="balance" class="form-control" value="{{ balance }}" step="0.01">
                </div>
                <div class="mb-3">
                    <label class="form-label">Risk Percentage (%)</label>
                    <input type="range" id="riskRange" class="form-range" min="0.5" max="5" step="0.5" value="1">
                    <div class="d-flex justify-content-between">
                        <small>0.5%</small>
                        <span id="riskValue" class="badge bg-primary">1%</span>
                        <small>5%</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Stop Loss (Pips)</label>
                    <input type="number" id="stopLoss" class="form-control" value="50" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Pip Value ($) - Per Standard Lot</label>
                    <select id="pipValue" class="form-select">
                        <option value="10">$10 (Major Pairs - EUR/USD, GBP/USD)</option>
                        <option value="8.5">$8.50 (USD/CHF)</option>
                        <option value="7.5">$7.50 (USD/CAD)</option>
                        <option value="6.5">$6.50 (AUD/USD, NZD/USD)</option>
                        <option value="100">$100 (Gold - XAU/USD)</option>
                    </select>
                </div>
                <button id="calculateBtn" class="btn btn-primary w-100">
                    <i class="bi bi-calculator"></i> Calculate Position Size
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-bar-chart-fill"></i> Calculation Results
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-12">
                        <h6 class="text-muted">Recommended Lot Size</h6>
                        <h1 id="lotSizeResult" class="display-4 text-primary">0.00</h1>
                        <small class="text-muted">Standard Lots</small>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Risk Amount</h6>
                                <h4 id="riskAmount" class="text-danger">$0.00</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Mini Lots</h6>
                                <h4 id="miniLots">0.00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Micro Lots</h6>
                                <h4 id="microLots">0.00</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Units</h6>
                                <h4 id="units">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Warning -->
        <div class="card mt-3 border-warning">
            <div class="card-body">
                <h6 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Risk Warning</h6>
                <ul class="small mb-0">
                    <li>Never risk more than 1-2% per trade</li>
                    <li>Always use stop losses</li>
                    <li>Maximum drawdown should not exceed 20%</li>
                    <li>This calculator is for educational purposes</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Quick Reference Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-info-circle"></i> Lot Size Reference
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Lot Type</th>
                            <th>Units</th>
                            <th>Pip Value (EUR/USD)</th>
                            <th>Example</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Standard Lot</strong></td>
                            <td>100,000</td>
                            <td>$10</td>
                            <td>1.00 lot</td>
                        </tr>
                        <tr>
                            <td><strong>Mini Lot</strong></td>
                            <td>10,000</td>
                            <td>$1</td>
                            <td>0.10 lot</td>
                        </tr>
                        <tr>
                            <td><strong>Micro Lot</strong></td>
                            <td>1,000</td>
                            <td>$0.10</td>
                            <td>0.01 lot</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const riskRange = document.getElementById('riskRange');
    const riskValue = document.getElementById('riskValue');
    const calculateBtn = document.getElementById('calculateBtn');

    riskRange.addEventListener('input', function() {
        riskValue.textContent = this.value + '%';
    });

    calculateBtn.addEventListener('click', function() {
        const balance = parseFloat(document.getElementById('balance').value);
        const riskPercent = parseFloat(riskRange.value);
        const stopLossPips = parseFloat(document.getElementById('stopLoss').value);
        const pipValue = parseFloat(document.getElementById('pipValue').value);

        fetch('/calculate_position', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                balance: balance,
                risk_percent: riskPercent,
                stop_loss_pips: stopLossPips,
                pip_value: pipValue
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('lotSizeResult').textContent = data.lot_size.toFixed(2);
            document.getElementById('riskAmount').textContent = '$' + data.risk_amount.toFixed(2);
            document.getElementById('miniLots').textContent = (data.lot_size * 10).toFixed(2);
            document.getElementById('microLots').textContent = (data.lot_size * 100).toFixed(2);
            document.getElementById('units').textContent = Math.round(data.lot_size * 100000).toLocaleString();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Calculation error. Please check your inputs.');
        });
    });

    // Calculate on page load
    calculateBtn.click();
});
</script>
{% endblock %}
