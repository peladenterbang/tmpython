{% extends 'base.html' %}

{% block title %}ICT Weekly Bias - Forex Risk Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2><i class="bi bi-bullseye"></i> ICT Weekly Bias</h2>
        <p class="text-muted">Previous Week High/Low → Weekly Bias → Entry on Tuesday-Thursday</p>
    </div>
</div>

<div class="row">
    <!-- Settings -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-gear"></i> Settings
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Pair</label>
                    <select id="pair" class="form-select">
                        <optgroup label="Major">
                            <option value="EUR/USD">EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="AUD/USD">AUD/USD</option>
                            <option value="USD/CAD">USD/CAD</option>
                        </optgroup>
                        <optgroup label="Metals">
                            <option value="XAU/USD">XAU/USD (Gold)</option>
                        </optgroup>
                        <optgroup label="Crypto">
                            <option value="BTC/USD">BTC/USD</option>
                            <option value="ETH/USD">ETH/USD</option>
                        </optgroup>
                        <optgroup label="Indices">
                            <option value="US30">US30 (Dow)</option>
                            <option value="US100">US100 (Nasdaq)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Timeframe</label>
                    <select id="interval" class="form-select">
                        <option value="15m">15 Minutes</option>
                        <option value="1h" selected>1 Hour</option>
                        <option value="4h">4 Hours</option>
                    </select>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Balance ($)</label>
                        <input type="number" id="balance" class="form-control" value="10000">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Risk %</label>
                        <input type="number" id="riskPercent" class="form-control" value="1" step="0.5">
                    </div>
                </div>
                <button id="analyzeBtn" class="btn btn-primary w-100 mb-3">
                    <i class="bi bi-search"></i> Analyze
                </button>
                <div id="loading" class="text-center mt-2 d-none">
                    <div class="spinner-border spinner-border-sm"></div>
                </div>
            </div>
        </div>

        <!-- Lot Calculator -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <i class="bi bi-calculator"></i> Lot Calculator
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label small">Stop Loss (pips)</label>
                    <input type="number" id="slPips" class="form-control form-control-sm" value="50" min="1">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Pip Value ($)</label>
                    <select id="pipValue" class="form-select form-select-sm">
                        <option value="10">$10 (Major pairs)</option>
                        <option value="1">$1 (Gold XAU)</option>
                        <option value="0.1">$0.10 (Crypto)</option>
                        <option value="5">$5 (Indices)</option>
                    </select>
                </div>
                <button id="calcLotBtn" class="btn btn-success btn-sm w-100 mb-2">
                    <i class="bi bi-calculator"></i> Calculate Lot
                </button>
                <div id="lotResult" class="alert alert-info py-2 mb-0 text-center d-none">
                    <strong>Lot Size: <span id="calcLot">0.00</span></strong><br>
                    <small>Risk: $<span id="calcRisk">0</span> | SL: <span id="calcSlPips">0</span> pips</small>
                </div>
            </div>
        </div>

        <!-- Trading Day -->
        <div class="card mb-3" id="tradingDayCard">
            <div class="card-header bg-info text-white">
                <i class="bi bi-calendar"></i> Trading Day
            </div>
            <div class="card-body text-center" id="tradingDay">
                <p class="text-muted mb-0">Click Analyze</p>
            </div>
        </div>

        <!-- How It Works -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-question-circle"></i> How It Works
            </div>
            <div class="card-body small">
                <ol class="mb-0 ps-3">
                    <li><strong>Previous Week High/Low</strong> - Key levels</li>
                    <li><strong>Weekly Bias</strong> - Which level will be taken</li>
                    <li><strong>Wait for Tuesday-Thursday</strong> - Best reversal days</li>
                    <li><strong>Find OB or FVG</strong> - Entry point</li>
                    <li><strong>Target</strong> - Previous week level</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Weekly Levels -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-calendar-week"></i> Weekly Levels
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h6 class="text-muted">Previous Week High</h6>
                        <h3 id="pwh" class="text-success">--</h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Previous Week Low</h6>
                        <h3 id="pwl" class="text-danger">--</h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Current Price</h6>
                        <h3 id="currentPrice" class="text-primary">--</h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Weekly Bias</h6>
                        <h3 id="weeklyBias" class="text-warning">--</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bias Reason -->
        <div class="alert alert-info" id="biasReason">
            <i class="bi bi-info-circle"></i> <span id="biasReasonText">Click Analyze to see weekly bias</span>
        </div>

        <!-- Custom Trade Calculator -->
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <i class="bi bi-calculator"></i> Custom Trade Calculator
            </div>
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small">Entry Price</label>
                        <input type="number" id="customEntry" class="form-control form-control-sm" step="0.00001" placeholder="Entry">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Stop Loss</label>
                        <input type="number" id="customSL" class="form-control form-control-sm" step="0.00001" placeholder="SL">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">Take Profit</label>
                        <input type="number" id="customTP" class="form-control form-control-sm" step="0.00001" placeholder="TP">
                    </div>
                    <div class="col-md-2">
                        <button id="customCalcBtn" class="btn btn-warning btn-sm w-100">Calculate</button>
                    </div>
                    <div class="col-md-4">
                        <div id="customResult" class="small">
                            <span class="text-muted">SL Pips: --</span> | 
                            <span class="text-muted">Lots: --</span> | 
                            <span class="text-muted">R:R: --</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Setup -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <i class="bi bi-bullseye"></i> Trade Setup (Auto-detected)
            </div>
            <div class="card-body" id="tradeSetup">
                <p class="text-muted text-center mb-0">No setup yet</p>
            </div>
        </div>

        <!-- OB and FVG -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-warning">
                        <i class="bi bi-box"></i> Order Blocks
                    </div>
                    <div class="card-body" id="orderBlocks">
                        <p class="text-muted small mb-0">--</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-layers"></i> Fair Value Gaps
                    </div>
                    <div class="card-body" id="fvgList">
                        <p class="text-muted small mb-0">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-graph-up"></i> Chart
            </div>
            <div class="card-body p-0" style="height: 400px;">
                <div id="chart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
let chart = null;

document.getElementById('analyzeBtn').addEventListener('click', analyze);
document.getElementById('calcLotBtn').addEventListener('click', calculateLot);
document.getElementById('customCalcBtn').addEventListener('click', calculateCustomTrade);

// Auto-set pip value based on pair
document.getElementById('pair').addEventListener('change', function() {
    const pair = this.value;
    const pipSelect = document.getElementById('pipValue');
    
    if (pair.includes('XAU')) {
        pipSelect.value = '1';
    } else if (pair.includes('BTC') || pair.includes('ETH')) {
        pipSelect.value = '0.1';
    } else if (pair.includes('US30') || pair.includes('US100') || pair.includes('US500')) {
        pipSelect.value = '5';
    } else {
        pipSelect.value = '10';
    }
});

function calculateLot() {
    const balance = parseFloat(document.getElementById('balance').value) || 10000;
    const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
    const slPips = parseFloat(document.getElementById('slPips').value) || 50;
    const pipValue = parseFloat(document.getElementById('pipValue').value) || 10;
    
    // Risk amount in dollars
    const riskAmount = balance * (riskPercent / 100);
    
    // Lot size = Risk Amount / (SL pips * Pip Value per standard lot)
    const lotSize = riskAmount / (slPips * pipValue);
    
    // Display result
    document.getElementById('calcLot').textContent = lotSize.toFixed(2);
    document.getElementById('calcRisk').textContent = riskAmount.toFixed(2);
    document.getElementById('calcSlPips').textContent = slPips;
    document.getElementById('lotResult').classList.remove('d-none');
}

function calculateCustomTrade() {
    const entry = parseFloat(document.getElementById('customEntry').value);
    const sl = parseFloat(document.getElementById('customSL').value);
    const tp = parseFloat(document.getElementById('customTP').value);
    const balance = parseFloat(document.getElementById('balance').value) || 10000;
    const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
    const pipValue = parseFloat(document.getElementById('pipValue').value) || 10;
    
    if (!entry || !sl) {
        alert('Please enter Entry and Stop Loss');
        return;
    }
    
    // Calculate SL in pips (assuming 4 decimal for forex, adjust for gold/crypto)
    const pair = document.getElementById('pair').value;
    let pipMultiplier = 10000; // Default for forex
    if (pair.includes('JPY')) pipMultiplier = 100;
    if (pair.includes('XAU')) pipMultiplier = 10;
    if (pair.includes('BTC') || pair.includes('ETH')) pipMultiplier = 1;
    if (pair.includes('US30') || pair.includes('US100')) pipMultiplier = 1;
    
    const slPips = Math.abs(entry - sl) * pipMultiplier;
    const tpPips = tp ? Math.abs(tp - entry) * pipMultiplier : 0;
    const rr = tpPips > 0 ? (tpPips / slPips).toFixed(1) : '--';
    
    // Calculate lot size
    const riskAmount = balance * (riskPercent / 100);
    const lotSize = riskAmount / (slPips * pipValue);
    
    // Determine direction
    const direction = sl < entry ? 'BUY' : 'SELL';
    
    document.getElementById('customResult').innerHTML = `
        <span class="badge ${direction === 'BUY' ? 'bg-success' : 'bg-danger'}">${direction}</span>
        <strong>SL: ${slPips.toFixed(1)} pips</strong> | 
        <strong>Lots: ${lotSize.toFixed(2)}</strong> | 
        <strong>R:R: ${rr}</strong> | 
        <span class="text-muted">Risk: $${riskAmount.toFixed(0)}</span>
    `;
}

function analyze() {
    const data = {
        pair: document.getElementById('pair').value,
        period: '1mo',
        interval: document.getElementById('interval').value,
        balance: parseFloat(document.getElementById('balance').value),
        risk_percent: parseFloat(document.getElementById('riskPercent').value)
    };
    
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('analyzeBtn').disabled = true;
    
    fetch('/analyze_ict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('analyzeBtn').disabled = false;
        
        if (result.error) {
            alert('Error: ' + result.error);
            console.log(result.trace);
            return;
        }
        
        updateUI(result);
        updateChart(result);
    })
    .catch(err => {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('analyzeBtn').disabled = false;
        alert('Error: ' + err);
    });
}

function updateUI(data) {
    // Weekly Levels
    document.getElementById('pwh').textContent = data.levels?.previous_week_high?.toFixed(5) || '--';
    document.getElementById('pwl').textContent = data.levels?.previous_week_low?.toFixed(5) || '--';
    document.getElementById('currentPrice').textContent = data.current_price?.toFixed(5) || '--';
    
    // Weekly Bias
    const biasEl = document.getElementById('weeklyBias');
    biasEl.textContent = data.weekly_bias || '--';
    biasEl.className = data.weekly_bias === 'BULLISH' ? 'text-success' : 
                       data.weekly_bias === 'BEARISH' ? 'text-danger' : 'text-warning';
    
    // Bias Reason
    document.getElementById('biasReasonText').textContent = data.bias_reason || '';
    document.getElementById('biasReason').className = 
        data.weekly_bias === 'BULLISH' ? 'alert alert-success' : 
        data.weekly_bias === 'BEARISH' ? 'alert alert-danger' : 'alert alert-info';
    
    // Trading Day
    const td = data.trading_day;
    if (td) {
        document.getElementById('tradingDay').innerHTML = `
            <h4>${td.day}</h4>
            <span class="badge ${td.is_optimal ? 'bg-success' : 'bg-warning'}">${td.is_optimal ? 'OPTIMAL' : 'WAIT'}</span>
            <p class="small mb-0 mt-2">${td.message}</p>
        `;
        document.getElementById('tradingDayCard').className = td.is_optimal ? 'card mb-3 border-success' : 'card mb-3 border-warning';
    }
    
    // Trade Setup
    const setupDiv = document.getElementById('tradeSetup');
    if (data.trade_setups && data.trade_setups.length > 0) {
        setupDiv.innerHTML = data.trade_setups.map(s => `
            <div class="border rounded p-3 mb-2 ${s.type === 'BUY' ? 'border-success bg-success bg-opacity-10' : 'border-danger bg-danger bg-opacity-10'}">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <span class="badge fs-5 ${s.type === 'BUY' ? 'bg-success' : 'bg-danger'}">${s.type}</span>
                        <div class="mt-2"><strong>${s.risk_reward}R</strong></div>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-sm mb-0">
                            <tr><td>Entry:</td><td><strong class="text-primary">${s.entry}</strong></td></tr>
                            <tr><td>Stop Loss:</td><td><strong class="text-danger">${s.stop_loss}</strong></td></tr>
                            <tr><td>Take Profit:</td><td><strong class="text-success">${s.take_profit}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-3">
                        <table class="table table-sm mb-0">
                            <tr><td>Lots:</td><td><strong>${s.lots}</strong></td></tr>
                            <tr><td>Risk:</td><td><strong>$${s.risk_amount}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-3">
                        <p class="mb-0 small">${s.reason}</p>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        setupDiv.innerHTML = '<p class="text-muted text-center mb-0">No valid setup found. Wait for price to reach OB/FVG.</p>';
    }
    
    // Order Blocks
    const obDiv = document.getElementById('orderBlocks');
    if (data.order_blocks && data.order_blocks.length > 0) {
        obDiv.innerHTML = data.order_blocks.map(ob => `
            <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <span class="badge ${ob.type === 'bullish' ? 'bg-success' : 'bg-danger'}">${ob.type.toUpperCase()}</span>
                <span>${ob.low?.toFixed(5)} - ${ob.high?.toFixed(5)}</span>
            </div>
        `).join('');
    } else {
        obDiv.innerHTML = '<p class="text-muted small mb-0">No Order Blocks found</p>';
    }
    
    // FVG
    const fvgDiv = document.getElementById('fvgList');
    if (data.fvg && data.fvg.length > 0) {
        fvgDiv.innerHTML = data.fvg.map(f => `
            <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <span class="badge ${f.type === 'bullish' ? 'bg-success' : 'bg-danger'}">${f.type.toUpperCase()}</span>
                <span>${f.low?.toFixed(5)} - ${f.high?.toFixed(5)}</span>
            </div>
        `).join('');
    } else {
        fvgDiv.innerHTML = '<p class="text-muted small mb-0">No FVG found</p>';
    }
}

function updateChart(data) {
    const container = document.getElementById('chart');
    container.innerHTML = '';
    
    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
        rightPriceScale: { borderColor: '#2a2e39' },
        timeScale: { borderColor: '#2a2e39', timeVisible: true }
    });
    
    const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderUpColor: '#26a69a', borderDownColor: '#ef5350',
        wickUpColor: '#26a69a', wickDownColor: '#ef5350'
    });
    
    const candles = data.ohlc.closes.map((_, i) => ({
        time: Math.floor(new Date(data.dates[i]).getTime() / 1000),
        open: data.ohlc.opens[i],
        high: data.ohlc.highs[i],
        low: data.ohlc.lows[i],
        close: data.ohlc.closes[i]
    }));
    candleSeries.setData(candles);
    
    // Previous Week High/Low lines
    if (data.levels?.previous_week_high) {
        candleSeries.createPriceLine({
            price: data.levels.previous_week_high,
            color: '#26a69a',
            lineWidth: 2,
            lineStyle: 0,
            title: 'PWH'
        });
    }
    if (data.levels?.previous_week_low) {
        candleSeries.createPriceLine({
            price: data.levels.previous_week_low,
            color: '#ef5350',
            lineWidth: 2,
            lineStyle: 0,
            title: 'PWL'
        });
    }
    
    // Trade setup lines
    if (data.trade_setups && data.trade_setups.length > 0) {
        const s = data.trade_setups[0];
        candleSeries.createPriceLine({ price: s.entry, color: '#2196f3', lineWidth: 2, lineStyle: 2, title: 'Entry' });
        candleSeries.createPriceLine({ price: s.stop_loss, color: '#f44336', lineWidth: 1, lineStyle: 2, title: 'SL' });
        candleSeries.createPriceLine({ price: s.take_profit, color: '#4caf50', lineWidth: 1, lineStyle: 2, title: 'TP' });
    }
    
    // Markers for OB
    const markers = [];
    data.order_blocks?.forEach(ob => {
        if (candles[ob.index]) {
            markers.push({
                time: candles[ob.index].time,
                position: ob.type === 'bullish' ? 'belowBar' : 'aboveBar',
                color: ob.type === 'bullish' ? '#26a69a' : '#ef5350',
                shape: ob.type === 'bullish' ? 'arrowUp' : 'arrowDown',
                text: 'OB'
            });
        }
    });
    
    data.fvg?.forEach(f => {
        if (candles[f.index]) {
            markers.push({
                time: candles[f.index].time,
                position: f.type === 'bullish' ? 'belowBar' : 'aboveBar',
                color: '#ff9800',
                shape: 'circle',
                text: 'FVG'
            });
        }
    });
    
    if (markers.length) {
        markers.sort((a, b) => a.time - b.time);
        candleSeries.setMarkers(markers);
    }
    
    chart.timeScale().fitContent();
    window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
}
</script>
{% endblock %}
