{% extends 'base.html' %}

{% block title %}ML Prediction - Forex Risk Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2><i class="bi bi-robot"></i> ML Entry/TP/SL Predictor</h2>
        <p class="text-muted">AI-powered trade setup predictions using technical analysis and pattern recognition</p>
    </div>
</div>

<div class="row">
    <!-- Settings Sidebar -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-gear"></i> Settings
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Trading Pair</label>
                    <select id="pair" class="form-select">
                        <optgroup label="Forex - Majors">
                            <option value="EUR/USD" selected>EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="USD/CHF">USD/CHF</option>
                            <option value="AUD/USD">AUD/USD</option>
                            <option value="USD/CAD">USD/CAD</option>
                            <option value="NZD/USD">NZD/USD</option>
                        </optgroup>
                        <optgroup label="Forex - Crosses">
                            <option value="EUR/GBP">EUR/GBP</option>
                            <option value="EUR/JPY">EUR/JPY</option>
                            <option value="EUR/CHF">EUR/CHF</option>
                            <option value="EUR/AUD">EUR/AUD</option>
                            <option value="EUR/CAD">EUR/CAD</option>
                            <option value="GBP/JPY">GBP/JPY</option>
                            <option value="GBP/CHF">GBP/CHF</option>
                            <option value="GBP/AUD">GBP/AUD</option>
                            <option value="AUD/JPY">AUD/JPY</option>
                            <option value="AUD/NZD">AUD/NZD</option>
                            <option value="AUD/CAD">AUD/CAD</option>
                            <option value="CAD/JPY">CAD/JPY</option>
                            <option value="CHF/JPY">CHF/JPY</option>
                            <option value="NZD/JPY">NZD/JPY</option>
                        </optgroup>
                        <optgroup label="Commodities">
                            <option value="XAU/USD">XAU/USD (Gold)</option>
                            <option value="XAG/USD">XAG/USD (Silver)</option>
                            <option value="BRENT">Brent Oil</option>
                            <option value="WTI">WTI Oil</option>
                        </optgroup>
                        <optgroup label="Crypto">
                            <option value="BTC/USD">BTC/USD (Bitcoin)</option>
                            <option value="ETH/USD">ETH/USD (Ethereum)</option>
                            <option value="SOL/USD">SOL/USD (Solana)</option>
                            <option value="XRP/USD">XRP/USD (Ripple)</option>
                            <option value="ADA/USD">ADA/USD (Cardano)</option>
                        </optgroup>
                        <optgroup label="Indices">
                            <option value="US30">US30 (Dow Jones)</option>
                            <option value="US100">US100 (Nasdaq)</option>
                            <option value="US500">US500 (S&P 500)</option>
                            <option value="GER40">GER40 (DAX)</option>
                            <option value="UK100">UK100 (FTSE)</option>
                            <option value="JPN225">JPN225 (Nikkei)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Period</label>
                    <select id="period" class="form-select">
                        <option value="5d">5 Days</option>
                        <option value="1mo" selected>1 Month</option>
                        <option value="3mo">3 Months</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Timeframe</label>
                    <select id="interval" class="form-select">
                        <option value="15m">15 Minutes</option>
                        <option value="30m">30 Minutes</option>
                        <option value="1h" selected>1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Balance ($)</label>
                        <input type="number" id="balance" class="form-control" value="{{ balance }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Risk %</label>
                        <input type="number" id="risk" class="form-control" value="1" step="0.5" min="0.5" max="5">
                    </div>
                </div>
                <button id="analyzeBtn" class="btn btn-primary w-100 mb-2">
                    <i class="bi bi-cpu"></i> Run ML Analysis
                </button>
                <div id="loading" class="text-center mt-2 d-none">
                    <div class="spinner-border spinner-border-sm"></div> Analyzing...
                </div>
            </div>
        </div>

        <!-- Trend Score -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-speedometer2"></i> Trend Score
            </div>
            <div class="card-body text-center">
                <h1 id="trendScore" class="display-2 mb-0">--</h1>
                <small class="text-muted">(-100 to +100)</small>
                <div id="trendDirection" class="h5 mt-2 mb-0">--</div>
            </div>
        </div>

        <!-- Technical Features -->
        <div class="card mb-3" id="featuresCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Technical Features
            </div>
            <div class="card-body p-2">
                <table class="table table-sm mb-0 small">
                    <tbody id="featuresTable"></tbody>
                </table>
            </div>
        </div>

        <!-- About ML Predict -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> How It Works
            </div>
            <div class="card-body small">
                <p class="mb-2 fw-bold">Entry Point Selection:</p>
                <div class="mb-2 p-2 bg-light" style="font-size:11px;">
                    <strong class="text-primary">1. Trend Analysis</strong>
                    <div>Combines multiple indicators:</div>
                    <ul class="mb-0 ps-3">
                        <li>SMA(20) vs SMA(50) crossover</li>
                        <li>RSI(14) overbought/oversold</li>
                        <li>MACD histogram direction</li>
                        <li>Bollinger Band position</li>
                    </ul>
                </div>
                
                <div class="mb-2 p-2 bg-light" style="font-size:11px;">
                    <strong class="text-primary">2. Entry Price</strong>
                    <div>Based on signal direction:</div>
                    <ul class="mb-0 ps-3">
                        <li><strong>BUY</strong>: Current price + small buffer</li>
                        <li><strong>SELL</strong>: Current price - small buffer</li>
                    </ul>
                </div>
                
                <hr>
                <p class="mb-2 fw-bold">Stop Loss Calculation:</p>
                <div class="mb-2 p-2 bg-light" style="font-size:11px;">
                    <strong class="text-danger">SL = Entry ± ATR × Multiplier</strong>
                    <ul class="mb-0 ps-3">
                        <li><strong>ATR(14)</strong>: Average True Range</li>
                        <li><strong>Multiplier</strong>: 1.5x - 2.0x ATR</li>
                        <li>BUY: SL below entry</li>
                        <li>SELL: SL above entry</li>
                    </ul>
                </div>
                
                <hr>
                <p class="mb-2 fw-bold">Take Profit Calculation:</p>
                <div class="mb-2 p-2 bg-light" style="font-size:11px;">
                    <strong class="text-success">TP = Entry ± (SL Distance × R:R)</strong>
                    <ul class="mb-0 ps-3">
                        <li><strong>R:R Ratio</strong>: 1.5:1 to 3:1</li>
                        <li>Higher confidence = higher R:R</li>
                        <li>Near S/R levels adjusted</li>
                    </ul>
                </div>
                
                <hr>
                <p class="mb-2 fw-bold">Lot Size Formula:</p>
                <div class="p-2 bg-light" style="font-size:11px;">
                    <strong class="text-primary">Lots = Risk$ / (SL pips × Pip Value)</strong>
                    <div class="mt-1">
                        <small>Risk$ = Balance × Risk%</small><br>
                        <small>Ensures max loss = your risk %</small>
                    </div>
                </div>
                
                <div class="alert alert-warning p-2 mt-2 mb-0" style="font-size:10px;">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> ML predictions are probabilistic. Always use proper risk management and don't risk more than 1-2% per trade.
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Chart -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up"></i> Candlestick Chart</span>
                <div>
                    <button id="telegramBtn" class="btn btn-sm btn-info me-2" onclick="sendToTelegram()" title="Send to Telegram">
                        <i class="bi bi-telegram"></i> Send Alert
                    </button>
                    <button id="captureBtn" class="btn btn-sm btn-outline-light" onclick="captureChart()" title="Save Chart">
                        <i class="bi bi-camera"></i> Capture
                    </button>
                </div>
            </div>
            <div class="card-body p-0" style="height: 450px;">
                <div id="chart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <!-- Trade Predictions -->
        <div class="card mb-3" id="predictionsCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> ML Trade Predictions
            </div>
            <div class="card-body" id="predictions"></div>
        </div>

        <!-- Analysis -->
        <div class="card mb-3" id="analysisCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-chat-text"></i> Analysis Summary
            </div>
            <div class="card-body">
                <ul id="analysisList" class="list-group list-group-flush"></ul>
            </div>
        </div>

        <!-- Previous Analysis Comparison -->
        <div class="card mb-3" id="comparisonCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Signal Comparison
            </div>
            <div class="card-body" id="comparisonBody"></div>
        </div>
    </div>
</div>

<div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
let chart = null;
let candleSeries = null;
let currentPair = 'EUR_USD';
let lastAnalysisData = null;
const subscriptionType = '{{ subscription }}';

function captureChart() {
    if (!chart) {
        alert('Please analyze a pair first');
        return;
    }
    
    const container = document.getElementById('chart');
    const canvases = container.querySelectorAll('canvas');
    
    if (canvases.length === 0) {
        alert('Chart not ready');
        return;
    }
    
    // Get container dimensions
    const rect = container.getBoundingClientRect();
    
    // Create a new canvas to composite all chart canvases
    const exportCanvas = document.createElement('canvas');
    exportCanvas.width = rect.width;
    exportCanvas.height = rect.height;
    const ctx = exportCanvas.getContext('2d');
    
    // Fill background
    ctx.fillStyle = '#131722';
    ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
    
    // Draw all canvases (main chart + price scale + time scale)
    canvases.forEach(canvas => {
        const canvasRect = canvas.getBoundingClientRect();
        const x = canvasRect.left - rect.left;
        const y = canvasRect.top - rect.top;
        ctx.drawImage(canvas, x, y);
    });
    
    // Add watermark/label
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.font = 'bold 16px Arial';
    ctx.fillText(currentPair.replace('/', '_') + ' - ML Predict', 10, 24);
    ctx.font = '12px Arial';
    ctx.fillText(new Date().toLocaleString() + ' | ' + subscriptionType + ' Plan', 10, 42);
    
    // Generate filename
    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `${currentPair.replace('/', '_')}_ML_${timestamp}.png`;
    
    // Download
    const link = document.createElement('a');
    link.download = filename;
    link.href = exportCanvas.toDataURL('image/png');
    link.click();
}

function sendToTelegram() {
    if (!chart || !lastAnalysisData) {
        alert('Please analyze a pair first');
        return;
    }
    
    const btn = document.getElementById('telegramBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
    
    // Capture chart image
    const container = document.getElementById('chart');
    const canvases = container.querySelectorAll('canvas');
    const rect = container.getBoundingClientRect();
    
    const exportCanvas = document.createElement('canvas');
    exportCanvas.width = rect.width;
    exportCanvas.height = rect.height;
    const ctx = exportCanvas.getContext('2d');
    
    ctx.fillStyle = '#131722';
    ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
    
    canvases.forEach(canvas => {
        const canvasRect = canvas.getBoundingClientRect();
        const x = canvasRect.left - rect.left;
        const y = canvasRect.top - rect.top;
        ctx.drawImage(canvas, x, y);
    });
    
    // Add watermark
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.font = 'bold 16px Arial';
    ctx.fillText(currentPair.replace('/', '_') + ' - ML Predict', 10, 24);
    ctx.font = '12px Arial';
    ctx.fillText(new Date().toLocaleString() + ' | ' + subscriptionType + ' Plan', 10, 42);
    
    const imageData = exportCanvas.toDataURL('image/png');
    
    // Get prediction info
    const pred = lastAnalysisData.predictions?.[0] || {};
    const features = lastAnalysisData.features || {};
    
    // Send to backend
    fetch('/send_ml_telegram_alert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            pair: currentPair,
            signal: pred.direction || 'WAIT',
            confidence: pred.confidence || 0,
            current_price: features.current_price || 'N/A',
            entry: pred.entry || 'N/A',
            stop_loss: pred.stop_loss || 'N/A',
            take_profit: pred.take_profit || 'N/A',
            risk_reward: pred.risk_reward || 'N/A',
            lots: pred.lots || 'N/A',
            trend_score: features.trend_score || 0,
            rsi: features.rsi || 'N/A',
            reason: pred.reason || 'N/A',
            image: imageData
        })
    })
    .then(r => r.json())
    .then(result => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-telegram"></i> Send Alert';
        
        if (result.success) {
            alert('Alert sent to Telegram successfully!');
        } else {
            alert('Error: ' + (result.error || 'Failed to send'));
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-telegram"></i> Send Alert';
        alert('Error: ' + err.message);
    });
}

document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);

async function runAnalysis() {
    const pair = document.getElementById('pair').value;
    const period = document.getElementById('period').value;
    const interval = document.getElementById('interval').value;
    const balance = parseFloat(document.getElementById('balance').value);
    const risk = parseFloat(document.getElementById('risk').value);
    
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('error').style.display = 'none';
    
    try {
        const response = await fetch('/analyze_ml', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pair, period, interval, balance, risk_percent: risk })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        displayResults(data);
    } catch (err) {
        document.getElementById('error').textContent = err.message;
        document.getElementById('error').style.display = 'block';
    } finally {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('analyzeBtn').disabled = false;
    }
}

function displayResults(data) {
    // Store current pair and analysis data
    currentPair = data.pair || 'EUR/USD';
    lastAnalysisData = data;
    
    // Trend Score
    const trendScore = data.features.trend_score;
    const trendEl = document.getElementById('trendScore');
    trendEl.textContent = trendScore;
    
    const trendDir = document.getElementById('trendDirection');
    if (trendScore >= 30) {
        trendDir.innerHTML = '<span class="text-success"><i class="bi bi-arrow-up-circle-fill"></i> BULLISH</span>';
        trendEl.className = 'display-2 mb-0 text-success';
    } else if (trendScore <= -30) {
        trendDir.innerHTML = '<span class="text-danger"><i class="bi bi-arrow-down-circle-fill"></i> BEARISH</span>';
        trendEl.className = 'display-2 mb-0 text-danger';
    } else {
        trendDir.innerHTML = '<span class="text-warning"><i class="bi bi-dash-circle-fill"></i> NEUTRAL</span>';
        trendEl.className = 'display-2 mb-0 text-warning';
    }
    
    // Features Table
    const f = data.features;
    document.getElementById('featuresTable').innerHTML = `
        <tr><td>Current Price</td><td class="text-end fw-bold">${f.current_price}</td></tr>
        <tr><td>RSI (14)</td><td class="text-end ${f.rsi > 70 ? 'text-danger' : f.rsi < 30 ? 'text-success' : ''}">${f.rsi || '--'}</td></tr>
        <tr><td>MACD</td><td class="text-end">${f.macd ? f.macd.toFixed(5) : '--'}</td></tr>
        <tr><td>SMA 20</td><td class="text-end">${f.sma_20 ? f.sma_20.toFixed(5) : '--'}</td></tr>
        <tr><td>SMA 50</td><td class="text-end">${f.sma_50 ? f.sma_50.toFixed(5) : '--'}</td></tr>
        <tr><td>BB Position</td><td class="text-end">${f.bb_position}%</td></tr>
        <tr><td>ATR</td><td class="text-end">${f.atr}</td></tr>
        <tr><td>Volatility</td><td class="text-end">${f.volatility}%</td></tr>
        <tr><td>Support</td><td class="text-end text-success">${f.support ? f.support.toFixed(5) : '--'}</td></tr>
        <tr><td>Resistance</td><td class="text-end text-danger">${f.resistance ? f.resistance.toFixed(5) : '--'}</td></tr>
    `;
    document.getElementById('featuresCard').style.display = 'block';
    
    // Predictions
    const predictionsDiv = document.getElementById('predictions');
    predictionsDiv.innerHTML = '';
    
    data.predictions.forEach((pred, idx) => {
        if (pred.direction !== 'WAIT') {
            const signalClass = pred.direction === 'BUY' ? 'signal-buy' : 'signal-sell';
            const badgeClass = pred.direction === 'BUY' ? 'badge-soft-success' : 'badge-soft-danger';
            predictionsDiv.innerHTML += `
                <div class="p-3 mb-2 ${signalClass}">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <span class="badge fs-6 ${badgeClass}">${pred.direction}</span>
                            <div class="mt-2"><strong>${pred.risk_reward}R</strong></div>
                            <small class="text-muted">${pred.confidence}% conf</small>
                        </div>
                        <div class="col-md-4">
                            <table class="table table-sm mb-0">
                                <tr><td>Entry:</td><td><strong class="text-primary">${pred.entry}</strong></td></tr>
                                <tr><td>Stop Loss:</td><td><strong class="text-danger">${pred.stop_loss}</strong></td></tr>
                                <tr><td>Take Profit:</td><td><strong class="text-success">${pred.take_profit}</strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-3">
                            <table class="table table-sm mb-0">
                                <tr><td>Lots:</td><td><strong>${pred.lots}</strong></td></tr>
                                <tr><td>Risk:</td><td><strong>$${pred.risk_amount}</strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-0 small">${pred.reason}</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            predictionsDiv.innerHTML += `
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-pause-circle"></i> <strong>WAIT</strong> - ${pred.reason}
                </div>
            `;
        }
    });
    document.getElementById('predictionsCard').style.display = 'block';
    
    // Analysis
    const analysisList = document.getElementById('analysisList');
    analysisList.innerHTML = '';
    data.analysis.forEach(item => {
        analysisList.innerHTML += `<li class="list-group-item"><i class="bi bi-check-circle text-primary"></i> ${item}</li>`;
    });
    document.getElementById('analysisCard').style.display = 'block';
    
    // Signal Comparison
    const comparisonBody = document.getElementById('comparisonBody');
    const currentSignal = data.predictions[0]?.direction || 'WAIT';
    const currentStrength = data.predictions[0]?.confidence || 0;
    
    if (data.previous) {
        const prev = data.previous;
        const signalMatch = currentSignal === prev.signal;
        const statusClass = signalMatch ? 'alert-success' : 'alert-warning';
        const statusIcon = signalMatch ? 'check-circle-fill' : 'exclamation-triangle-fill';
        const statusText = signalMatch ? 'Signal Consistent' : 'Signal Changed!';
        
        comparisonBody.innerHTML = `
            <div class="alert ${statusClass} mb-3 py-2">
                <i class="bi bi-${statusIcon}"></i> <strong>${statusText}</strong>
            </div>
            <div class="row text-center">
                <div class="col-6">
                    <small class="text-muted">Previous</small>
                    <div class="h5 mb-1">
                        <span class="badge ${prev.signal === 'BUY' ? 'badge-soft-success' : prev.signal === 'SELL' ? 'badge-soft-danger' : 'badge-soft-secondary'}">
                            ${prev.signal || 'N/A'}
                        </span>
                    </div>
                    <small class="text-muted">${prev.strength || 0}% strength</small>
                    <div class="small text-muted mt-1">
                        <i class="bi bi-clock"></i> ${prev.analyzed_at || 'N/A'}
                    </div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Current</small>
                    <div class="h5 mb-1">
                        <span class="badge ${currentSignal === 'BUY' ? 'badge-soft-success' : currentSignal === 'SELL' ? 'badge-soft-danger' : 'badge-soft-secondary'}">
                            ${currentSignal}
                        </span>
                    </div>
                    <small class="text-muted">${currentStrength}% strength</small>
                    <div class="small text-muted mt-1">
                        <i class="bi bi-clock"></i> ${data.analyzed_at || 'Just now'}
                    </div>
                </div>
            </div>
            ${!signalMatch ? '<div class="alert alert-info mt-3 mb-0 py-2 small"><i class="bi bi-info-circle"></i> Signal changed since last analysis. Consider waiting for confirmation.</div>' : ''}
        `;
        document.getElementById('comparisonCard').style.display = 'block';
    } else {
        comparisonBody.innerHTML = `
            <div class="text-center text-muted py-2">
                <i class="bi bi-info-circle"></i> First analysis for this pair/timeframe.<br>
                <small>Run again later to compare signals.</small>
            </div>
        `;
        document.getElementById('comparisonCard').style.display = 'block';
    }
    
    // Chart
    drawChart(data);
}

function drawChart(data) {
    const container = document.getElementById('chart');
    container.innerHTML = '';
    
    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
        rightPriceScale: { borderColor: '#2a2e39' },
        timeScale: { borderColor: '#2a2e39', timeVisible: true },
        crosshair: {
            mode: 0,
            vertLine: { labelVisible: true },
            horzLine: { labelVisible: true }
        }
    });
    
    candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderUpColor: '#26a69a', borderDownColor: '#ef5350',
        wickUpColor: '#26a69a', wickDownColor: '#ef5350',
        priceFormat: {
            type: 'price',
            precision: 5,
            minMove: 0.00001
        }
    });
    
    const candles = data.ohlc.closes.map((_, i) => ({
        time: Math.floor(new Date(data.dates[i]).getTime() / 1000),
        open: data.ohlc.opens[i],
        high: data.ohlc.highs[i],
        low: data.ohlc.lows[i],
        close: data.ohlc.closes[i]
    }));
    candleSeries.setData(candles);
    
    // Support/Resistance lines
    if (data.features.support) {
        candleSeries.createPriceLine({
            price: data.features.support,
            color: '#26a69a',
            lineWidth: 1,
            lineStyle: 2,
            title: 'Support'
        });
    }
    if (data.features.resistance) {
        candleSeries.createPriceLine({
            price: data.features.resistance,
            color: '#ef5350',
            lineWidth: 1,
            lineStyle: 2,
            title: 'Resistance'
        });
    }
    
    // SMA lines
    if (data.features.sma_20) {
        candleSeries.createPriceLine({
            price: data.features.sma_20,
            color: '#ff9800',
            lineWidth: 1,
            lineStyle: 0,
            title: 'SMA20'
        });
    }
    
    // Trade prediction lines
    const pred = data.predictions[0];
    if (pred && pred.direction !== 'WAIT') {
        candleSeries.createPriceLine({
            price: pred.entry,
            color: '#2196f3',
            lineWidth: 2,
            lineStyle: 2,
            title: 'Entry'
        });
        candleSeries.createPriceLine({
            price: pred.stop_loss,
            color: '#f44336',
            lineWidth: 2,
            lineStyle: 2,
            title: 'SL'
        });
        candleSeries.createPriceLine({
            price: pred.take_profit,
            color: '#4caf50',
            lineWidth: 2,
            lineStyle: 2,
            title: 'TP'
        });
    }
    
    chart.timeScale().fitContent();
    
    // Handle resize
    window.addEventListener('resize', () => {
        chart.applyOptions({ width: container.clientWidth });
    });
}
</script>
{% endblock %}
